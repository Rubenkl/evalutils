from pathlib import Path

import SimpleITK
from sklearn.metrics import accuracy_score
from evalutils import ClassificationEvaluation, DetectionEvaluation
from evalutils.io import CSVLoader, SimpleITKLoader
from evalutils.validators import ExpectedColumnNamesValidator, NumberOfCasesValidator, UniquePathIndicesValidator, UniqueImagesValidator


class {{ cookiecutter.package_name|capitalize }}(

{%- if cookiecutter.challenge_kind == "Detection" -%}
    DetectionEvaluation
{%- else -%}
    ClassificationEvaluation
{%- endif -%}

):
{%- if cookiecutter.challenge_kind == "Classification" %}
    def __init__(self):
        super().__init__(
            file_loader=CSVLoader(),
            validators=(
                ExpectedColumnNamesValidator(expected=("case", "class",)),
            ),
            join_key="case",
        )

    def score_aggregates(self):
        return {
            "accuracy_score": accuracy_score(
                self._cases["class_ground_truth"],
                self._cases["class_prediction"],
             ),
        }
{% elif cookiecutter.challenge_kind == "Detection" %}
    pass
{% elif cookiecutter.challenge_kind == "Segmentation" %}
    def __init__(self):
        super().__init__(
            file_loader=SimpleITKLoader(),
            validators=(
                NumberOfCasesValidator(num_cases=2),
                UniquePathIndicesValidator(),
            ),
        )

    @staticmethod
    def score_case(*, idx, case):
        gt_path = case["path_ground_truth"]
        pred_path = case["path_prediction"]

        gt = SimpleITK.ReadImage(str(gt_path), SimpleITK.sitkUInt8)
        pred = SimpleITK.ReadImage(str(pred_path), SimpleITK.sitkUInt8)

        assert hash(SimpleITK.GetArrayFromImage(gt).tostring()) == case["hash_ground_truth"]
        assert hash(SimpleITK.GetArrayFromImage(pred).tostring()) == case["hash_prediction"]

        overlap_measures = SimpleITK.LabelOverlapMeasuresImageFilter()
        overlap_measures.Execute(gt, pred)

        return {
            'FalseNegativeError': overlap_measures.GetFalseNegativeError(),
            'FalsePositiveError': overlap_measures.GetFalsePositiveError(),
            'MeanOverlap': overlap_measures.GetMeanOverlap(),
            'UnionOverlap': overlap_measures.GetUnionOverlap(),
            'VolumeSimilarity': overlap_measures.GetVolumeSimilarity(),
            'JaccardCoefficient': overlap_measures.GetJaccardCoefficient(),
            'DiceCoefficient': overlap_measures.GetDiceCoefficient(),
            'pred_fname': pred_path.name,
            'gt_fname': gt_path.name,
        }

{% endif %}

if __name__ == "__main__":
    evaluation = {{ cookiecutter.package_name|capitalize }}()
    evaluation.evaluate()
